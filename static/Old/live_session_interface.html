<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Medical Session - Auto Journal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .live-badge {
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: inline-block;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .session-setup {
            padding: 30px;
            border-bottom: 1px solid #e9ecef;
        }

        .setup-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 500;
            color: #4a5568;
        }

        .form-group input, .form-group select {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
        }

        .session-controls {
            text-align: center;
            padding: 20px;
            background: #f8fafc;
            border-bottom: 1px solid #e9ecef;
        }

        .session-button {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            cursor: pointer;
            font-weight: 600;
            margin: 0 10px;
            transition: all 0.3s ease;
        }

        .session-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(72, 187, 120, 0.3);
        }

        .session-button.stop {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
        }

        .session-button.stop:hover {
            box-shadow: 0 8px 25px rgba(229, 62, 62, 0.3);
        }

        .session-button:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .status-display {
            padding: 20px;
            text-align: center;
        }

        .status-active {
            background: #e6fffa;
            color: #234e52;
            border-left: 4px solid #48bb78;
        }

        .status-processing {
            background: #faf089;
            color: #744210;
            border-left: 4px solid #f6e05e;
        }

        .status-complete {
            background: #e6fffa;
            color: #234e52;
            border-left: 4px solid #38a169;
        }

        .live-display {
            display: none;
            padding: 20px;
        }

        .live-display.active {
            display: block;
        }

        .transcription-panes {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .transcription-pane {
            background: #f8fafc;
            border-radius: 10px;
            padding: 20px;
            min-height: 300px;
            border-left: 4px solid;
        }

        .provider-pane {
            border-left-color: #3182ce;
        }

        .patient-pane {
            border-left-color: #38a169;
        }

        .pane-header {
            font-weight: 600;
            margin-bottom: 15px;
            color: #2d3748;
        }

        .transcript-entry {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .entry-timestamp {
            font-size: 0.75rem;
            color: #718096;
            margin-bottom: 5px;
        }

        .entry-original {
            font-weight: 500;
            color: #2d3748;
            margin-bottom: 5px;
            line-height: 1.4;
        }

        .entry-translation {
            color: #4a5568;
            font-style: italic;
            margin-bottom: 5px;
        }

        .entry-confidence {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .high-confidence {
            background: #c6f6d5;
            color: #22543d;
        }

        .medium-confidence {
            background: #faf089;
            color: #744210;
        }

        .low-confidence {
            background: #fed7d7;
            color: #742a2a;
        }

        .empty-transcripts {
            color: #a0aec0;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }

        .privacy-notice {
            background: #fff5f5;
            color: #c53030;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            margin-top: 10px;
            text-align: center;
        }

        .journal-preview {
            display: none;
            padding: 30px;
            background: #f0fff4;
        }

        .journal-preview.show {
            display: block;
        }

        .journal-status {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            border-left: 4px solid #48bb78;
        }

        .view-journal-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: 600;
            margin: 10px;
        }

        .journal-entries-list {
            padding: 20px;
            display: none;
        }

        .journal-entries-list.show {
            display: block;
        }

        .journal-entry-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .journal-entry-card:hover {
            transform: translateY(-2px);
        }

        .entry-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
        }

        .entry-title {
            font-weight: 600;
            color: #2d3748;
            font-size: 1.1rem;
        }

        .entry-date {
            color: #4a5568;
            font-size: 0.9rem;
        }

        .entry-summary {
            color: #4a5568;
            margin-bottom: 10px;
        }

        .entry-badges {
            display: flex;
            gap: 8px;
        }

        .entry-badge {
            background: #e2e8f0;
            color: #4a5568;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
        }

        .entry-badge.ai-generated {
            background: #c6f6d5;
            color: #22543d;
        }

        @media (max-width: 768px) {
            .transcription-panes {
                grid-template-columns: 1fr;
            }
            
            .setup-form {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Live Medical Session</h1>
            <p>Real-time translation with automatic journal generation</p>
            <div class="live-badge" id="liveBadge">Ready to Start</div>
        </div>

        <!-- Session Setup -->
        <div class="session-setup" id="sessionSetup">
            <div class="setup-form">
                <div class="form-group">
                    <label>Patient Name</label>
                    <input type="text" id="patientName" placeholder="Enter patient name" value="Mary Johnson">
                </div>
                <div class="form-group">
                    <label>Family ID</label>
                    <input type="text" id="familyId" placeholder="Enter family ID" value="kris">
                </div>
                <div class="form-group">
                    <label>User ID</label>
                    <input type="text" id="userId" placeholder="Enter user ID" value="user-001">
                </div>
                <div class="form-group">
                    <label>Target Language</label>
                    <select id="targetLanguage">
                        <option value="vi">Vietnamese (Tiáº¿ng Viá»‡t)</option>
                        <option value="es">Spanish (EspaÃ±ol)</option>
                        <option value="zh">Chinese (ä¸­æ–‡)</option>
                        <option value="fr">French (FranÃ§ais)</option>
                        <option value="de">German (Deutsch)</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Session Controls -->
        <div class="session-controls">
            <button class="session-button" id="startSessionBtn" onclick="startLiveSession()">
                ðŸŽ¤ Start Live Session
            </button>
            <button class="session-button stop" id="stopSessionBtn" onclick="stopLiveSession()" disabled>
                ðŸ›‘ End Session & Generate Journal
            </button>
            <button class="view-journal-btn" id="viewJournalBtn" onclick="showJournalEntries()">
                ðŸ“– View My Journal Entries
            </button>
        </div>

        <!-- Status Display -->
        <div class="status-display" id="statusDisplay">
            <div id="sessionStatus">Ready to begin medical visit session</div>
        </div>

        <!-- Live Session Display -->
        <div class="live-display" id="liveDisplay">
            <div class="transcription-panes">
                <div class="transcription-pane provider-pane">
                    <div class="pane-header">ðŸ©º Healthcare Provider</div>
                    <div id="providerTranscripts">
                        <div class="empty-transcripts">Healthcare provider conversation will appear here...</div>
                    </div>
                </div>
                <div class="transcription-pane patient-pane">
                    <div class="pane-header">ðŸ‘¤ Patient/Family</div>
                    <div id="patientTranscripts">
                        <div class="empty-transcripts">Patient/family conversation will appear here...</div>
                    </div>
                </div>
            </div>
            
            <div class="privacy-notice">
                ðŸ”’ Transcription text automatically deleted after 10 seconds for privacy. Only summary journal entry is retained.
            </div>
        </div>

        <!-- Journal Preview -->
        <div class="journal-preview" id="journalPreview">
            <div class="journal-status">
                <h3>âœ… Medical Visit Journal Created!</h3>
                <p>Your visit has been automatically summarized and added to your journal.</p>
                <button class="view-journal-btn" onclick="viewGeneratedJournal()">
                    ðŸ“‹ View Journal Entry
                </button>
            </div>
        </div>

        <!-- Journal Entries List -->
        <div class="journal-entries-list" id="journalEntriesList">
            <h2>Your Medical Journal Entries</h2>
            <div id="entriesContainer">
                <!-- Journal entries will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentSessionId = null;
        let sessionSocket = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let sessionSegments = [];
        let recordingTimer = null;

        // Main session functions
        async function startLiveSession() {
            const patientName = document.getElementById('patientName').value;
            const familyId = document.getElementById('familyId').value;
            const userId = document.getElementById('userId').value;
            const targetLanguage = document.getElementById('targetLanguage').value;

            if (!patientName || !familyId || !userId) {
                alert('Please fill in all required fields');
                return;
            }

            // Update UI immediately
            document.getElementById('startSessionBtn').disabled = true;
            document.getElementById('stopSessionBtn').disabled = false;
            document.getElementById('liveBadge').textContent = 'Live Session Active';
            document.getElementById('sessionStatus').textContent = `Live session active for ${patientName}`;
            document.getElementById('sessionStatus').className = 'status-active';
            document.getElementById('liveDisplay').classList.add('active');

            // Start audio recording directly (skip backend session for now)
            startAudioRecording();
            console.log('Live session started for', patientName);
        }

        async function stopLiveSession() {
            stopAudioRecording();

            // Update UI
            document.getElementById('stopSessionBtn').disabled = true;
            document.getElementById('liveBadge').textContent = 'Session Complete';
            document.getElementById('sessionStatus').textContent = 'Medical visit session completed';
            document.getElementById('sessionStatus').className = 'status-complete';

            // For now, just show completion message instead of journal generation
            setTimeout(() => {
                document.getElementById('liveDisplay').classList.remove('active');
                document.getElementById('journalPreview').classList.add('show');
                resetSession();
            }, 2000);

            console.log('Session ended');
        }

        // Audio recording functions
        async function startAudioRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 16000
                    }
                });

                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm;codecs=opus'
                });

                mediaRecorder.ondataavailable = function(event) {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = function() {
                    processAudioChunk();
                };

                mediaRecorder.start();
                isRecording = true;

                // Process chunks every 10 seconds (your proven interval)
                recordingTimer = setInterval(() => {
                    if (isRecording && mediaRecorder && mediaRecorder.state === 'recording') {
                        mediaRecorder.stop();
                        setTimeout(() => {
                            if (isRecording && mediaRecorder) {
                                mediaRecorder.start();
                            }
                        }, 100);
                    }
                }, 10000);

            } catch (error) {
                console.error('Audio recording error:', error);
                alert('Failed to start audio recording: ' + error.message);
            }
        }

        function stopAudioRecording() {
            isRecording = false;

            if (recordingTimer) {
                clearInterval(recordingTimer);
                recordingTimer = null;
            }

            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }

            if (mediaRecorder && mediaRecorder.stream) {
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
        }

        // Audio processing with your working speaker detection
        async function processAudioChunk() {
            if (audioChunks.length === 0) {
                return;
            }

            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            
            if (audioBlob.size < 1000) {
                audioChunks = [];
                return;
            }

            audioChunks = [];

            try {
                const formData = new FormData();
                formData.append('file', audioBlob, 'audio.webm');
                formData.append('target_language', document.getElementById('targetLanguage').value);
                formData.append('source_language', 'auto');
                formData.append('family_id', document.getElementById('familyId').value);

                // Use your working endpoint
                const response = await fetch('http://localhost:8000/combined/enhanced-live-diarize/', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success && result.speaker_segments) {
                    result.speaker_segments.forEach(segment => {
                        if (segment.text && segment.text.trim().length > 2) {
                            addConversationEntry(segment);
                            sessionSegments.push(segment);
                        }
                    });

                    updateStatus(`Processed ${result.speaker_segments.length} segments`);
                } else {
                    console.log('No segments processed:', result);
                }

            } catch (error) {
                console.error('Processing error:', error);
                if (isRecording) {
                    showError('Translation failed: ' + error.message);
                }
            }
        }

        // Display functions with your working speaker logic
        function addConversationEntry(segment) {
            const timestamp = new Date().toLocaleTimeString();
            const speaker = segment.speaker || 'SPEAKER_1';
            const originalText = segment.text;
            const translatedText = segment.translation || '[Translation pending...]';
            const confidence = segment.confidence || 0.8;

            // Your proven speaker classification
            const speakerLabel = speaker === 'SPEAKER_1' ? 'Healthcare Provider' : 'Patient/Family';

            // Determine confidence class
            let confidenceClass = 'medium-confidence';
            if (confidence > 0.8) confidenceClass = 'high-confidence';
            else if (confidence < 0.6) confidenceClass = 'low-confidence';

            // Add to correct pane
            const targetPane = speaker === 'SPEAKER_1' ? 
                document.getElementById('providerTranscripts') : 
                document.getElementById('patientTranscripts');

            // Clear empty state if it exists
            const emptyState = targetPane.querySelector('.empty-transcripts');
            if (emptyState) {
                emptyState.remove();
            }

            const entry = document.createElement('div');
            entry.className = 'transcript-entry';
            entry.innerHTML = `
                <div class="entry-timestamp">${timestamp}</div>
                <div class="entry-original">${originalText}</div>
                <div class="entry-translation">â†’ ${translatedText}</div>
                <div class="entry-confidence ${confidenceClass}">
                    ${Math.round(confidence * 100)}% confidence
                </div>
            `;
            
            targetPane.appendChild(entry);
            targetPane.scrollTop = targetPane.scrollHeight;
        }

        // Helper functions
        function updateStatus(message) {
            document.getElementById('sessionStatus').textContent = message;
        }

        function showError(message) {
            alert(message);
        }

        function resetSession() {
            currentSessionId = null;
            sessionSegments = [];
            document.getElementById('startSessionBtn').disabled = false;
            document.getElementById('stopSessionBtn').disabled = true;
            document.getElementById('liveBadge').textContent = 'Ready to Start';
            
            // Clear transcripts
            document.getElementById('providerTranscripts').innerHTML = '<div class="empty-transcripts">Healthcare provider conversation will appear here...</div>';
            document.getElementById('patientTranscripts').innerHTML = '<div class="empty-transcripts">Patient/family conversation will appear here...</div>';
        }

        function showJournalEntries() {
            document.getElementById('journalEntriesList').classList.toggle('show');
        }

        function viewGeneratedJournal() {
            alert('Journal entry viewer would open here - integrate with your journal display system');
        }
    </script>
</body>
</html>